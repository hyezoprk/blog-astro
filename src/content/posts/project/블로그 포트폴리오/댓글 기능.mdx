---
title: ëŒ“ê¸€ ê¸°ëŠ¥ ì¶”ê°€ (Prisma+GraphQL)
date: '2022-10-27'
categories: project
tags: "ë¸”ë¡œê·¸ í¬íŠ¸í´ë¦¬ì˜¤"
description: feat
---
<HeadingNavigator />

### ë„ì… ë°°ê²½
Prisma ê³µë¶€ë¥¼ í•˜ê¸´ í–ˆëŠ”ë° ë§‰ìƒ ì ìš©ì„ í•˜ìë‹ˆ ì—„ë‘ê°€ ì•ˆ ë‚¬ë‹¤. ê·¸ëŸ´ ë• ì–¸ì œë‚˜ ì¹œìˆ™í•œ ê²ƒë¶€í„°.. ë‚˜ëŠ” í•´ë³´ê³  ì‹¶ì€ ê±´ ì¼ë‹¨ ë¸”ë¡œê·¸ì— ì‹œë„í•´ë³´ëŠ” ê²ƒ ê°™ë‹¤. ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë„ í•´ì•¼ í•˜ëŠ”ë°, í•˜ë‚˜ë¼ë„ ì˜í•˜ìëŠ” ê°•ë°•ì´ ì¢€ ê³ ì§ˆì ì¸ ë¬¸ì œ;;
<br/>
ì•„ë¬´íŠ¼ ì²˜ìŒë¶€í„° ëŒ“ê¸€ì„ ë§Œë“¤ë ¤ë˜ ê±´ ì•„ë‹ˆì—ˆë‹¤. ë„¤ì´ë²„ ë¸”ë¡œê·¸ë¥¼ í•  ë•Œë„ ëŒ“ê¸€ì€ ë‹«ê³  ì‚´ì•˜ê³ , ë­£ë³´ë‹¤ ê·¸ëƒ¥ ëŒ“ê¸€ì°½ë“¤ì´ ì•ˆ ì˜ˆì˜ë‹¤ê³  ìƒê°í–ˆë‹¤. íŠ¹íˆ `utterance` ê°™ì€ ê²ƒì˜ êµ¬í˜„ì€ ì •ë§ ë³µë¶™ì´ê¸° ë•Œë¬¸ì— ì‹¤ë ¥ ëŠ˜ë¦¬ëŠ” ê±°ë‘ì€ ë³„ ìƒê´€ì—†ë‹¤ê³  ìƒê°í•˜ê¸°ë„ í–ˆê³ .
<br/>
<Img src='/images/2022/autumm/ìŠ¤ìƒ·_Vercel.webp' />
<br/>

ê·¸ë˜ì„œ í•˜ë ¤ë˜ ê²ƒì´ `ì›¹ì†Œì¼“`ìœ¼ë¡œ 1ëŒ€1 ì±„íŒ… ê¸°ëŠ¥ì„ ì‹¬ëŠ” ê±°ì˜€ë‹¤. í—Œë° `Vercel` ì¸¡ì—ì„œ ë§í•˜ê¸¸ ì„œë²„ë¦¬ìŠ¤ í™˜ê²½ì—ì„œ ì›¹ì†Œì¼“ êµ¬í˜„ì€ í˜ë“¤ë‹¤ê³ . ê²°êµ­ ë¬¼ê¼¬ë¥¼ í‹€ì–´ ëŒ“ê¸€ ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ë³´ëŠ” ê²ƒìœ¼ë¡œ ë°©í–¥ì„ í…„ë‹¤. ë§‰ìƒ í•´ë³´ë‹ˆ ì˜í•œ ê²°ì •ì´ì—ˆë˜ ê²ƒ ê°™ë‹¤.  
<br/>
ë•Œë§ˆì¹¨ ì¦ê²¨ë“£ëŠ” ìœ íŠœë²„ <q>ì¹´ì¼</q>ì˜ Nested Comment ì˜ìƒì´ ìˆì—ˆë‹¤. í•­ìƒ ëŠë¼ì§€ë§Œ ì„¤ëª…ì„ ì§„ì§œ ì˜í•œë‹¤. `GraphQL`ì´ë‚˜ `NextAuth`ë¥¼ ë‹¤ë£¨ì§€ëŠ” ì•Šì§€ë§Œ ê·¸ê±´ ë‚´ê°€ í•  ì¼ì´ê³ , ê·¸ì˜ ë¡œì§ì— ë§ì€ ë¹šì„ ì¡Œë‹¤.  
<br/>
ê¸°ë³¸ì ì¸ CRUD ê¸°ëŠ¥ì„ ì—°ìŠµí•˜ê¸° ì¢‹ì•˜ê³  ê·¸íì—˜ì˜ ì¿¼ë¦¬ ë©”ì»¤ë‹ˆì¦˜ì—ë„ í•œê²° ìµìˆ™í•´ì§ˆ ìˆ˜ ìˆì—ˆë‹¤.  

### Postgres + AWS ì„ ì • ì´ìœ 
ë”±íˆ ì—†ë‹¤.  
ë‚˜ëŠ” ìš°ì„  `Nextauth`ë¡œ ë¡œê·¸ì¸ ê¸°ëŠ¥ë¶€í„° êµ¬í˜„í–ˆëŠ”ë° ê±°ê¸°ì„œ ëŒ€í‘œë¡œ ì†Œê°œë˜ê³  ìˆë˜ dbê°€ RDBSì—ì„œ `PostgreSQL`, NoSQLì—ì„  `MongoDB`ì˜€ë‹¤.  
ì²˜ìŒì—ëŠ” ê·¸ëƒ¥ ìµìˆ™í•˜ë‹ˆê¹Œ `MongoDB`(Atlas)ì—ì„œ ì‘ì—…í–ˆëŠ”ë°, DBì˜ ê·¼ë³¸ì¸ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ë„ ê¶ê¸ˆí•´ì„œ ë°”ê¿”íƒ”ë‹¤.  
í•˜ì§€ë§Œ `prisma`ë¥¼ ì“°ëŠ” ë§Œí¼ ì‚¬ìš©ìƒì—ì„œ ë‘˜ì˜ ì°¨ì´ë¥¼ ëŠë¼ê¸´ í˜ë“¤ì—ˆë‹¤. ëª½ê³ ë””ë¹„ ì“¸ ë• ì•„ ì˜¤ë¸Œì íŠ¸êµ¬ë‚˜ ì‹¶ì—ˆë˜ ê±¸ ì´ì œ ì•„ í…Œì´ë¸”ì´êµ¬ë‚˜ í•˜ëŠ” ì²˜ì°¸í•œ ìˆ˜ì¤€ã…‹ã…‹ğŸ˜£ 

### Apollo GraphQL
ì•„í´ë¡œ ì„œë²„ì˜ `context` ìë¦¬ëŠ” ê·¸íì—˜ `resolvers`ì˜ ì„¸ë²ˆì§¸ ì¸ìë¡œ ë“¤ì–´ì˜¤ëŠ”, ë§¤ìš° ìœ ìš©í•œ ê¿€ë‹¨ì§€ ìë¦¬ë‹¤ğŸ¯ <q>NextAuth</q>ì˜ `session`ê³¼ <q>prisma</q>ì˜ `client`ë¥¼ ì´ê³³ì— ë„£ì–´ì£¼ë©´ ì¼ì´ ë˜ê²Œ ì‰¬ì›Œì§„ë‹¤.
```ts graphql.ts focus=9:11
import prisma from "@/lib/graphql/prismadb";
import { getSession } from "next-auth/react";
...

const apolloServer = new ApolloServer({
  schema,
  csrfPrevention: true,
  cache: "bounded",
  context: async ({ req }): Promise<GraphqlContext> => {
    const session = await getSession({ req });
    return { session, prisma };
  },
});
```
<br/>
> ê°„ë‹¨í•œ ì˜ˆì‹œë¡œ ë³´ë©´ <q>ì„¸ì…˜ ë°ì´í„°</q>ëŠ” ì´ë ‡ê²Œ ë¡œê·¸ì¸ ê²€ì¦ì´ë‚˜ í”„ë¦¬ì¦ˆë§ˆ <q>relation</q>ì˜ ì´ìŒìƒˆë¡œ ë‘ë£¨ë‘ë£¨ ì“°ì´ê²Œ ëœë‹¤.  
<CH.Code>
```ts ../resolvers/comments.ts
import { CreateCommentResponse, GraphqlContext, Root } from "@/types";
const resolvers = {
  ...

  Mutation: {
    createComment: async (
      _: Root,
      args: { message: string; postId: string },
      context: GraphqlContext,
    ): Promise<CreateCommentResponse> => {
      const { message, postId } = args;
      const { session, prisma } = context;

      if (!session?.user)
        return {
          error: "ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”",
        };

      try {
        await prisma.comment.create({
          data: {
            message,
            postId,
            user: {
              connect: {
                id: session.user.id,
              },
            },
            image: {
              connect: {
                id: session.user.id,
              },
            },
          },
        });

        return { success: true };
      } catch (e) {
        return {
          error: (e as Error).message,
        };
      }
    },
  }
}
```
```ts type.ts
import { PrismaClient } from "@prisma/client";
import { Session } from "next-auth";

export interface GraphqlContext {
  session: Session | null;
  prisma: PrismaClient;
}

export type Root = any;

/**
 * * ìœ ì €
 */
export interface CreateUsernameData {
  createUsername: {
    success: boolean;
    error: string;
  };
}
export interface CreateUsernameInput {
  username: string;
}
export interface CreateUsernameResponse {
  success?: boolean;
  error?: string;
}
...
...
/**
 * * ì½”ë©˜íŠ¸
 */
export interface LoadCommentsData {
  loadComments: LoadComment[];
}
export interface LoadCommentsInput {
  postId: string;
}
export interface LoadComment {
  id: string;
  nickname: string;
  message: string;
  postId: string;
  profileImage: string;
  createdAt: string;
  updatedAt: string;
  parentId: string | null;
  secret: boolean;
  _count: {
    likes: number;
  };
}
...
...
...
```
</CH.Code>
### Prisma ëª¨ë¸ë§
ê·¸íì—˜ ì„¸íŒ…ì´ ëë‚¬ìœ¼ë©´ ë³¸ê²©ì ìœ¼ë¡œ ì¼í•  ë•Œë‹¤. í”„ë¦¬ì¦ˆë§ˆ ì…‹íŒ…ì€ ë‹¤ë¥¸ í¬ìŠ¤íŠ¸ì—ì„œ í–ˆë˜ ê²ƒ ê°™ìœ¼ë‹ˆ ìƒëµí•˜ê³ ã…  
ê·¼ë° ê¶ê¸ˆí•œ ê±´ë°, ì¼í•˜ì‹œëŠ” ë¶„ë“¤ ìˆœì„œë¥¼ ë‘ëŠ”ì§€, ì•„ë‹ˆë©´ ì†ì´ ê°€ëŠ” ëŒ€ë¡œ í•˜ëŠ”ì§€ ëª¨ë¥´ê² ë‹¤. ì´ê²Œ ìƒê°ë³´ë‹¤ ë§ì´ ì™”ë‹¤ê°”ë‹¤ í•˜ê³ , ë˜ ê²¹ì¹˜ëŠ” êµ¬ì„ë„ ìˆì–´ì„œ,, ë‚˜ëŠ” ì¼ë‹¨ í”„ë¦¬ì¦ˆë§ˆ ìŠ¤í‚¤ë§ˆë¶€í„° ì§œê³ , ê·¸ í›„ì— ê·¸íì—˜ì˜ `resolvers` -> `typesDefs` -> `operations & type` ìˆœìœ¼ë¡œ ë§Œë“¤ ë•Œ ì¢€ ë” íë¦„ì„ ì´í•´í•˜ë©´ì„œ ì‘ì—…í•  ìˆ˜ ìˆë‹¤ê³  ëŠê¼ˆë‹¤. ë¬¼ë¡  í•˜ë‹¤ë³´ë‹ˆ ì‚˜ ê°€ëŠ” ëŒ€ë¡œ í•˜ê¸´ í–ˆëŠ”ë°ã… í í  
<Img src='/images/2022/autumm/ìŠ¤ìƒ·_í”„ë¦¬ì¦ˆë§ˆëª¨ë¸ë§.webp' />
<figcaption>schema.prisma</figcaption>
<br/>
ì•„ë¬´íŠ¼ ìŠ¤í‚¤ë§ˆì™€ `typeDefs`ëŠ” ê±°ì˜ ê°™ì€ ì‘ì—…ì´ë‹¤. ê·¸ë˜ì„œ ì‚¬ì‹¤ ì¢€ ì¬ë¯¸ëŠ” ì—†ì—ˆê³ , ì œì¼ ì¬ë°ŒëŠ” ë¶€ë¶„ì€ ì—­ì‹œ ì‹¤ì œ ì¼ì„ ìˆ˜í–‰í•˜ê²Œ ë˜ëŠ” `resolvers`ì˜€ë‹¤. `prisma` ë©”ì¨ë“œëŠ” ì´ ì•ˆì—ì„œ í™œìš©ëœë‹¤. ì–´ë–¤ ê¸°ëŠ¥ë“¤ì´ ìˆëŠ”ì§€ë§Œ ì•Œë©´ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ì— ì˜í•´ ìë™ì™„ì„± ê¸°ëŠ¥ì´ ì§€ì›ë˜ê¸° ë•Œë¬¸ì— í¬ê²Œ ì–´ë ¤ìš´ ê±´ ì—†ì„ ê²ƒ ê°™ì•˜ë‹¤. ë¬¼ë¡  ê·¸ê±°ë‘ "ì•„ë‹ˆ ì™œ ì•ˆë¼?"ëŠ” ë³„ê°œì˜ ë¬¸ì œë‹¤...
<br/>
<br/>
`resolvers`ì˜ ì‘ì„±, ê·¸ë¦¬ê³  ìˆ˜í–‰ëœ ë°ì´í„°ì˜ `refetch` ê°™ì€ ê±´ ë‹¤ìŒì£¼ì— ê³„ì†